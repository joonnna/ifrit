<html>
    <head>
        <title> Chord visualization </title>
        <style>
        body {
            color: #d3d3d3;
            font: 12pt arial;
            background-color: #222222;
        }

        #mynetwork {
            width: 800px;
            height: 800px;i
            position: relative;
            margin-left: auto;
            margin-right: auto;
            margin-top: 100px;
            border: 1px solid #444444;
            background-color: #222222;
        }
        </style>
        <link src="www.visjs.org/dist/vis.css" rel="stylesheet" type="text/css"/>
        <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script type="text/javascript"  src="http://visjs.org/dist/vis.js"> </script>
    </head>
    </body>
    <input type="button" value="Add Node" id="addNode">
    <input type="button" value="Shutdown node" id="shutdownNode">
    <input type="button" value="Crash node" id="crashNode">
    <input type="button" value="Corrupt a node" id="corruptNode">
    <input type="button" value="Stabilize" id="stabilize">
    <div id="mynetwork">
        <div class="vis-network" tabindex="900" style="position: relative; overflow: hidden; touch-action: pan-y; -webkit-user-select: none; -webkit-user-drag: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); width: 100%; height: 100%;"><canvas width="800" height="800" style="position: relative; touch-action: none; -webkit-user-select: none; -webkit-user-drag: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); width: 100%; height: 100%;"></canvas></div>
    </div>
    <script type="text/javascript">
var network;
var dataset = new vis.DataSet([])
var singleEdges = new vis.DataSet([])
var edges = new vis.DataSet([])
    var socket = io();
    var nodata = true
    socket.on('add', function(message) {
        var id = message.data.ID
        var trusted = message.data.Trusted
        dataset.add([{id: id, label: id, http: message.data.HttpAddr, trusted: trusted}]);
        if (nodata) {
            init()
        }
    });
socket.on('remove', function(message) {
    dataset.remove({id: message.data.ID});

    nextid = message.data.ID + "next"
    previd = message.data.ID + "prev"
    edges.remove({id: nextid})
    edges.remove({id: previd})
});
socket.on('update', function(message) {
    nextid = message.data.ID + "next"
    previd = message.data.ID + "prev"
    edges.update({id: nextid, from: message.data.ID, to: message.data.Next})
    edges.update({id: previd, from: message.data.ID, to: message.data.Prev})
});

function init() {
    var container = document.getElementById('mynetwork')
        var data = {
            nodes: dataset,
            edges: edges
        };
    var options = {
        layout: {
            improvedLayout: true,
        },
        physics: {
            stabilization: false,
        },
        nodes: {
            shape: 'dot',
            size: 15,
            font: {
                size: 12,
                color: '#ffffff'
            },
            borderWidth: 2,
        },
        edges: {
            width: 2,
        }
    };
    network = new vis.Network(container, data, options)
}

function shutdown() {
    var randomNodes = dataset.get().filter(function(node) {
        return node.trusted === false
    });
    console.log(randomNodes.length);
    if (randomNodes.length === 0) {
        return
    }
    var idx = Math.floor((Math.random() * randomNodes.length) + 1);

    var randomNode = randomNodes[idx];
    if randomNode === null {
        console.log("No node found")
        return
    }
    console.log(randomNode);
    var x = new XMLHttpRequest();
    x.open('GET', randomNode.http + "/shutdownNode", true);
    x.send(null);
}

function crash() {
    var randomNodes = dataset.get({
        filter: function(item) {
            return (item.color != "red" && item.trusted === false);
        }
    });
    console.log(randomNodes.length);
    if (randomNodes.length === 0) {
        return
    }
    var idx = Math.floor((Math.random() * randomNodes.length) + 1);

    var randomNode = randomNodes[idx];
    if randomNode === null {
        console.log("No node found")
        return
    }
    console.log(randomNode);
    var x = new XMLHttpRequest();
    x.open('GET', randomNode.http + "/crashNode", true);
    x.send(null);

    var allRings = dataset.get({
        filter: function(item) {
            return (item.http == randomNode.http);
        }
    });

    allRings.forEach(function(node) {
        dataset.update({id: node.id, color: "red"})
    });
}

function corrupt() {
    var randomNodes = dataset.get({
        filter: function(item) {
            return (item.color != "red" && item.color != "green");
        }
    });
    console.log(randomNodes.length);
    if (randomNodes.length === 0) {
        return
    }
    var idx = Math.floor((Math.random() * randomNodes.length) + 1);

    var randomNode = randomNodes[idx];
    if randomNode === null {
        console.log("No node found")
        return
    }

    console.log(randomNode);
    var x = new XMLHttpRequest();
    x.open('GET', randomNode.http + "/corruptNode", true);
    x.send(null);

    var allRings = dataset.get({
        filter: function(item) {
            return (item.http == randomNode.http);
        }
    });

    allRings.forEach(function(node) {
        dataset.update({id: node.id, color: "green"})
    });

}


function add() {
    var x = new XMLHttpRequest();
    x.open('GET', "http://localhost:5632/addNode", true);
    x.send(null);
}

function stabilize() {
    network.stabilize();
}


var shutdownButton = document.getElementById('shutdownNode');
shutdownButton.onclick = function() {shutdown();};

var crashbutton = document.getElementById('crashNode');
crashbutton.onclick = function() {crash();};

var corruptbutton = document.getElementById('corruptNode');
corruptbutton.onclick = function() {corrupt();};

var addbutton = document.getElementById('addNode');
addbutton.onclick = function() {add();};

var stabbutton = document.getElementById('stabilize');
stabbutton.onclick = function() {stabilize();};


function addEdge(id, destination) {
    var newEdge = id.concat(destination)
    var revEdge = destination.concat(id)
    try {
        singleEdges.add([{id: newEdge, from: id, to: destination}])
    }
    catch(err) {
        return
    }
    var edge = singleEdges.get(revEdge)
    if (edge != null) {
        edges.add([{id: newEdge, from: id, to: destination}])
    }
}



    </script>
    </body>
</html>
